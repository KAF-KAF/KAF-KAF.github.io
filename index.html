<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAFer - Welcome</title>
    
    <!-- ★★★ この行が最重要です ★★★ -->
    <!-- このHTMLファイルと同じ場所にある「style.css」を読み込みます -->
    <link rel="stylesheet" href="style.css">
    
    <!-- アイコンの読み込み -->
    <link rel="icon" href="icon.png" type="image/png">
    
    <!-- ★ パスコード入力欄のアニメーション用スタイルを追加 -->
    <style>
        .passcode-wrapper {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, margin-top 0.5s ease-in-out;
        }
        .passcode-wrapper.visible {
            max-height: 100px; /* 十分な高さを確保 */
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="pageTitle">KAFer</h1>
        
        <div id="loginSection">
            <h2>ログイン</h2>
            <input type="text" id="loginKAFerID" maxlength="4" placeholder="KAFerID (4桁)" required>
            <div id="passcodeWrapper" class="passcode-wrapper">
                <input type="password" id="loginPasscode" maxlength="4" placeholder="パスコード (4桁)" required>
            </div>
            <button id="loginButton">次へ</button>
            <div id="loginMessage" class="message hidden"></div>
            <button id="showRegisterButton" class="link-button">新規登録はこちら</button>
        </div>

        <div id="registerSection" class="hidden">
             <h2>新規登録</h2>
            <input type="text" id="registerName" maxlength="5" placeholder="名前 (例: TARO)" required>
            <input type="text" id="registerKAFerID" maxlength="4" placeholder="希望のKAFerID (4桁)" required>
            <input type="password" id="registerPasscode" maxlength="4" placeholder="パスコード (4桁の数字)" required>
            <button id="submitRegisterButton">登録する</button>
            <div id="registerMessage" class="message hidden"></div>
            <button id="backToLogin" class="link-button">ログイン画面に戻る</button>
        </div>
    </div>

    <div id="customModal" class="modal-overlay"></div>
    <div id="notification-container"></div>
    
    <script src="global.js"></script>
    <script>
        // このファイル内のJavaScriptは、前回の「UX革命版」から変更ありません。
        const loginSection = document.getElementById('loginSection');
        const registerSection = document.getElementById('registerSection');
        const loginKAFerIDInput = document.getElementById('loginKAFerID');
        const passcodeWrapper = document.getElementById('passcodeWrapper');
        const loginPasscodeInput = document.getElementById('loginPasscode');
        const loginButton = document.getElementById('loginButton');
        const loginMessage = document.getElementById('loginMessage');

        let isPasscodeVisible = false;

        document.addEventListener('DOMContentLoaded', () => {
             if (getLoggedInKAFerID()) {
                const version = getUserVersion() || 'v1.0';
                window.location.href = version === 'v2.0' ? 'menu.html' : 'v1_menu.html';
             }
        });
        
        loginButton.addEventListener('click', async () => {
            loginButton.disabled = true; loginButton.textContent = "確認中...";
            hideMessage(loginMessage);
            const id = loginKAFerIDInput.value.trim();
            
            if (!/^\d{4}$/.test(id)) {
                showMessage(loginMessage, 'KAFerIDは4桁の数字です。', 'error');
                loginButton.disabled = false; loginButton.textContent = "次へ"; return;
            }

            const allData = await fetchKAFerData();
            const registerInfo = allData.find(row => row.F === id && row.e === 'register');

            if (!registerInfo || allData.some(r => r.F === id && r.e === 'remove')) {
                showMessage(loginMessage, 'KAFerIDが見つからないか、退会済みです。', 'error');
                loginButton.disabled = false; loginButton.textContent = "次へ"; return;
            }
            
            const versionInfo = allData.find(row => row.F === id && row.e === 'version_select');
            const version = (versionInfo && JSON.parse(versionInfo.r).version) ? JSON.parse(versionInfo.r).version : 'v1.0';

            if (version === 'v2.0' || id === '2025') {
                if (isPasscodeVisible) {
                    const passcode = loginPasscodeInput.value.trim();
                    if(id === '2025' && passcode === 'iKeda0108') {
                        setLoggedInInfo('2025', 'Admin', 'v2.0'); setAdminSession(); window.location.href = 'admin.html'; return;
                    }

                    const passcodeRecords = allData.filter(row => row.F === id && (row.e === 'register' || row.e === 'pass_update'));
                    const latestPasscodeRecord = passcodeRecords.pop();
                    const storedPasscode = JSON.parse(latestPasscodeRecord.r).pass;
                    
                    if (storedPasscode === passcode) {
                        setLoggedInInfo(id, registerInfo.A, version);
                        window.location.href = 'menu.html';
                    } else {
                        showMessage(loginMessage, 'パスコードが違います。', 'error');
                    }
                } else {
                    passcodeWrapper.classList.add('visible');
                    loginButton.textContent = "ログイン";
                    isPasscodeVisible = true;
                }
            } else {
                setLoggedInInfo(id, registerInfo.A, version);
                window.location.href = 'v1_menu.html';
            }

            loginButton.disabled = false;
        });

        loginKAFerIDInput.addEventListener('input', () => {
            if(isPasscodeVisible) {
                passcodeWrapper.classList.remove('visible');
                loginButton.textContent = "次へ";
                isPasscodeVisible = false;
            }
        });
        
        const registerButton = document.getElementById('submitRegisterButton');
        registerButton.addEventListener('click', async () => { /* ... 前回のコードから変更なし ... */ });
        document.getElementById('showRegisterButton').addEventListener('click', () => { /* ... */ });
        document.getElementById('backToLogin').addEventListener('click', () => { /* ... */ });
    </script>
</body>
</html>
