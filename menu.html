<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>KAFer - v2.0 メニュー</title><link id="favicon" rel="icon" href="icon.png" type="image/png"><link rel="stylesheet" href="style.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"><link rel="manifest" href="manifest.webmanifest"></head><body class="app-container"><header class="app-header"><div class="logo"><h1>KAFer</h1></div><div class="user-controls"><span class="user-info-header" id="header-user-info"></span><button class="logout-btn" onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i> ログアウト</button></div></header><div class="main-content-wrapper"><aside class="sidebar"><nav><ul><li><a href="#" onclick="showSection('dashboard-section'); return false;" class="active"><i class="fas fa-home"></i> ダッシュボード</a></li><li><a href="#" onclick="showSection('payment-section'); return false;"><i class="fas fa-wallet"></i> 会費</a><ul><li><a href="#" onclick="showSection('payment-section'); return false;"><i class="fas fa-hand-holding-usd"></i> KAFerマネーコード入力</a></li><li><a href="#" onclick="showSection('my-payments-section'); return false;"><i class="fas fa-file-invoice-dollar"></i> マイ支払い状況</a></li><li><a href="#" onclick="showSection('refund-request-section'); return false;"><i class="fas fa-undo-alt"></i> KAFerマネー返金申請</a></li></ul></li><li><a href="#" onclick="showSection('pass-update-section'); return false;"><i class="fas fa-user-lock"></i> パスコード変更</a></li><li id="admin-link-sidebar" style="display: none;"><a href="admin.html"><i class="fas fa-user-cog"></i> 管理者ダッシュボード</a></li></ul></nav></aside><main class="container"><div id="message-area" class="message"></div><div id="dashboard-section" class="content-section"><h2><i class="fas fa-tachometer-alt"></i> ダッシュボード</h2><div class="dashboard-metrics"><div class="metric-card"><div class="value" id="dashboard-name"></div><div class="label">ユーザー名</div></div><div class="metric-card secondary"><div class="value" id="dashboard-kaferId"></div><div class="label">KAFer ID</div></div><div class="metric-card accent"><div class="value" id="dashboard-kafer-money">0KAFer</div><div class="label">KAFerマネー残高</div></div></div><div class="card" style="margin-top: var(--spacing-xl);"><div class="card-header"><i class="fas fa-money-bill-wave"></i> 今月の支払い状況</div><div class="list-group"><div class="list-group-item"><span>今月の支払い必要額 (延滞含む):</span><span id="current-monthly-due" style="font-weight: bold;">0KAFer</span></div><div class="list-group-item"><span>KAFerマネーが充当された後の未払い額:</span><span id="outstanding-amount-display" style="font-weight: bold;">0KAFer</span></div><div class="list-group-item"><span>KAFerマネーの過払い額:</span><span id="excess-amount-display" style="font-weight: bold;">0KAFer</span></div><div class="list-group-item"><span>支払いステータス:</span><span id="payment-status-display" style="font-weight: bold; color: var(--error-color);">未確認</span></div></div></div><h3 style="margin-top: var(--spacing-xxl);"><i class="fas fa-bell"></i> あなたへのお知らせ</h3><div class="card"><div id="user-notifications"><div class="log-entry"><i class="fas fa-info-circle"></i> 最新の情報が表示されます。</div></div></div><h3 style="margin-top: var(--spacing-xxl);"><i class="fas fa-info-circle"></i> 運営からのお知らせ</h3><div class="card"><div id="admin-announcements"><div class="log-entry"><i class="fas fa-info-circle"></i> 運営からのお知らせがここに表示されます。</div></div></div></div><div id="payment-section" class="content-section" style="display: none;"><h2><i class="fas fa-hand-holding-usd"></i> KAFerマネーコード入力</h2><div id="reader"></div><div class="qr-scanner-controls" style="margin-top: var(--spacing-md);"><button id="start-scanner-btn" class="btn btn-secondary"><i class="fas fa-camera"></i> QRコードをスキャン</button><button id="stop-scanner-btn" class="btn btn-danger" style="display: none;"><i class="fas fa-stop-circle"></i> スキャン停止</button></div><form id="payment-form" style="margin-top: var(--spacing-xl);"><div class="form-group"><label for="payment-code"><i class="fas fa-barcode"></i> KAFerマネーコード (16桁の数字)</label><input type="text" id="payment-code" required pattern="[0-9]{16}" title="16桁の数字を入力してください"></div><button type="submit" class="btn"><i class="fas fa-money-check-alt"></i> コードを使用</button></form><script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script></div><div id="my-payments-section" class="content-section" style="display: none;"><h2><i class="fas fa-file-invoice-dollar"></i> マイ支払い状況</h2><div class="tab-navigation" id="my-payments-tab-nav"><button class="tab-button active" data-target="recent-payments"><i class="fas fa-history"></i> 最近の記録</button><button class="tab-button" data-target="all-records"><i class="fas fa-list-ul"></i> 全ての記録</button></div><div class="tab-content-wrapper"><div id="recent-payments" class="tab-content"><h3>最新5件の活動記録</h3><div class="data-table-container"><table class="data-table"><thead><tr><th>日付</th><th>種別</th><th>詳細</th></tr></thead><tbody id="my-payments-recent-list"></tbody></table></div></div><div id="all-records" class="tab-content" style="display: none;"><h3>全ての活動記録</h3><div class="data-table-container"><table class="data-table"><thead><tr><th>日付</th><th>種別</th><th>詳細</th></tr></thead><tbody id="my-payments-all-list"></tbody></table></div></div></div></div><div id="refund-request-section" class="content-section" style="display: none;"><h2><i class="fas fa-undo-alt"></i> KAFerマネー返金申請</h2><p style="margin-bottom: var(--spacing-md);">現在のKAFerマネー残高: <span id="current-money-balance-refund" style="font-weight: bold;">0KAFer</span></p><form id="refund-request-form"><div class="form-group"><label for="refund-amount-input"><i class="fas fa-yen-sign"></i> 返金を希望する金額 (100円単位)</label><input type="number" id="refund-amount-input" required min="100" step="100" title="100円以上の100円単位で入力してください"></div><p style="font-size: 0.9em; color: var(--medium-grey);"><i class="fas fa-info-circle"></i> 返金には手数料として<span id="refund-fee-yen-display">100円 (10000KAFer)</span>がかかります。<br>実際に返金されるKAFerマネーは、入力された円額をKAFerマネーに換算し、そこから手数料<span id="refund-fee-kaf-display">10000KAFer</span>を引いた額となります。<br>返金は**10000KAFerマネー単位**で可能です。</p><p id="refund-code-display" style="font-weight: bold; color: var(--info-color); margin-top: var(--spacing-md); display: none;"><i class="fas fa-exclamation-circle"></i> 返還コード: <span id="generated-refund-code" style="color: var(--primary-dark);"></span> (このコードを管理者に提示してください)</p><button type="submit" class="btn btn-danger"><i class="fas fa-paper-plane"></i> 返金申請を提出</button></form></div><div id="pass-update-section" class="content-section" style="display: none;"><h2><i class="fas fa-user-lock"></i> パスコード変更</h2><form id="pass-update-form"><div class="form-group"><label for="current-password"><i class="fas fa-key"></i> 現在のパスコード</label><input type="password" id="current-password" required></div><div class="form-group"><label for="new-password"><i class="fas fa-unlock-alt"></i> 新しいパスコード (4桁以上の半角英数字記号)</label><input type="password" id="new-password" required pattern="[a-zA-Z0-9!@#$%^&amp;*()_+\-=\\[\\]{}|;:'&lt;&gt;\\./?]{4,}" title="4文字以上の半角英数字記号を入力してください"></div><div class="form-group"><label for="confirm-new-password"><i class="fas fa-check-double"></i> 新しいパスコード (確認)</label><input type="password" id="confirm-new-password" required pattern="[a-zA-Z0-9!@#$%^&amp;*()_+\-=\\[\\]{}|;:'&lt;&gt;\\./?]{4,}" title="4文字以上の半角英数字記号を入力してください"></div><button type="submit" class="btn btn-secondary"><i class="fas fa-exchange-alt"></i> パスコードを変更</button></form></div></main></div><footer class="app-footer"><p>&copy; 2025 KAFer App. All rights reserved.</p></footer><script src="crypto.js"></script><script src="global.js"></script><script>let currentSection='dashboard-section';let html5QrCode=null;document.addEventListener('DOMContentLoaded',async()=>{initializePwaAndDarkMode();await checkLoginStatus(!0,!1,'menu.html');const user=getLoggedInUser();if(!user)return;document.getElementById('header-user-info').textContent=`${user.name} (${user.kaferId})`;if(user.isAdmin){document.getElementById('admin-link-sidebar').style.display='block'}window.showSection=(sectionId)=>{document.querySelectorAll('.content-section').forEach(section=>{section.style.display='none'});document.getElementById(sectionId).style.display='block';document.querySelectorAll('.sidebar nav ul li a').forEach(link=>{link.classList.remove('active')});const targetLink=document.querySelector(`.sidebar nav ul li a[onclick*="showSection('${sectionId}')"]`);if(targetLink){targetLink.classList.add('active');const parentLi=targetLink.closest('ul').previousElementSibling;if(parentLi&&parentLi.tagName==='A'){parentLi.classList.add('active')}}currentSection=sectionId;if(html5QrCode){html5QrCode.stop().then(()=>{console.log("QR Code scanning stopped.");document.getElementById('start-scanner-btn').style.display='block';document.getElementById('stop-scanner-btn').style.display='none';html5QrCode=null;hideMessage('message-area')}).catch(err=>{console.error("Error stopping QR Code scanning:",err)})}if(sectionId==='my-payments-section'){showTabContent('my-payments-tab-nav','recent-payments')}};await updateDashboardAndPayments();await loadUserNotifications();await loadAdminAnnouncements();document.getElementById('refund-fee-yen-display').textContent=`${PROJECT_CONFIG.REFUND_FEE_YEN}円 (${PROJECT_CONFIG.REFUND_FEE_KAF}KAFer)`;document.getElementById('refund-fee-kaf-display').textContent=`${PROJECT_CONFIG.REFUND_FEE_KAF}KAFer`;document.getElementById('payment-form').addEventListener('submit',async e=>{e.preventDefault();hideMessage('message-area');const moneyCode=document.getElementById('payment-code').value;if(!moneyCode||!/^[0-9]{16}$/.test(moneyCode)){showMessage('message-area','16桁のKAFerマネーコードを入力してください。','error');return}const records=await fetchSheetData();const validMoneyCodeRecord=records.find(r=>r.type==='money_code_issue'&&r.moneyCode===moneyCode);if(!validMoneyCodeRecord){showMessage('message-area','無効なKAFerマネーコードです。','error');return}const isVoided=records.some(r=>r.type==='money_code_void'&&r.moneyCode===moneyCode);if(isVoided){showMessage('message-area','このKAFerマネーコードは無効化されています。','error');return}const alreadyUsed=records.some(r=>r.type==='payment'&&r.paymentCode===moneyCode);if(alreadyUsed){showMessage('message-area','このKAFerマネーコードは既に使用済みです。','info');return}const success=await writeToSheet(user.name,user.kaferId,'payment',{paymentCode:moneyCode,amount:validMoneyCodeRecord.amount});if(success){showMessage('message-area',`KAFerマネーコード ${moneyCode} (${kafToYen(validMoneyCodeRecord.amount)}円相当) を使用しました。残高に反映されます。`,'success');document.getElementById('payment-form').reset();await updateDashboardAndPayments();await loadUserNotifications()}else{showMessage('message-area','KAFerマネーコードの使用に失敗しました。','error')}});document.getElementById('refund-request-form').addEventListener('submit',async e=>{e.preventDefault();hideMessage('message-area');document.getElementById('refund-code-display').style.display='none';const requestAmountYen=parseInt(document.getElementById('refund-amount-input').value,10);const requestAmountKaf=yenToKaf(requestAmountYen);const records=await fetchSheetData();const currentBalanceKaf=calculateKAFerMoneyBalance(user.kaferId,records);if(isNaN(requestAmountYen)||requestAmountYen<PROJECT_CONFIG.REFUND_FEE_YEN||requestAmountYen%PROJECT_CONFIG.REFUND_FEE_YEN!==0){showMessage('message-area',`返金希望額は${PROJECT_CONFIG.REFUND_FEE_YEN}円以上の${PROJECT_CONFIG.REFUND_FEE_YEN}円単位で入力してください。`,'error');return}if(requestAmountKaf>currentBalanceKaf){showMessage('message-area',`KAFerマネー残高が不足しています。現在の残高は${currentBalanceKaf}KAFerです。`,'error');return}const refundAmountAfterFeeKaf=requestAmountKaf-PROJECT_CONFIG.REFUND_FEE_KAF;if(refundAmountAfterFeeKaf<0||refundAmountAfterFeeKaf%PROJECT_CONFIG.REFUND_UNIT_KAF!==0){showMessage('message-area',`手数料を引いた後、返金されるKAFerマネーは${PROJECT_CONFIG.REFUND_UNIT_KAF}KAFer (${kafToYen(PROJECT_CONFIG.REFUND_UNIT_KAF)}円相当) 単位である必要があります。`,'error');return}const refundCode=generateRandomRefundCode();if(confirm(`KAFerマネー ${requestAmountKaf}KAFer (${kafToYen(requestAmountKaf)}円相当) の返金申請を提出しますか？\n手数料 ${PROJECT_CONFIG.REFUND_FEE_KAF}KAFer (${PROJECT_CONFIG.REFUND_FEE_YEN}円相当) を差し引き、${refundAmountAfterFeeKaf}KAFerが返金されます。`)){const success=await writeToSheet(user.name,user.kaferId,'refund_request',{requestAmountYen:requestAmountYen,requestAmountKaf:requestAmountKaf,refundAmountAfterFeeKaf:refundAmountAfterFeeKaf,refundCode:refundCode,status:'pending'});if(success){showMessage('message-area',`KAFerマネー ${requestAmountKaf}KAFerの返金申請を提出しました。`,'success');document.getElementById('refund-request-form').reset();document.getElementById('generated-refund-code').textContent=refundCode;document.getElementById('refund-code-display').style.display='block';await updateDashboardAndPayments();await loadUserNotifications()}else{showMessage('message-area','返金申請の提出に失敗しました。','error')}}});document.getElementById('pass-update-form').addEventListener('submit',async e=>{e.preventDefault();hideMessage('message-area');const currentPassword=document.getElementById('current-password').value;const newPassword=document.getElementById('new-password').value;const confirmNewPassword=document.getElementById('confirm-new-password').value;if(!currentPassword||!newPassword||!confirmNewPassword){showMessage('message-area','すべてのフィールドを入力してください。','error');return}if(!/^[a-zA-Z0-9!@#$%^&amp;*()_+\-=\\[\\]{}|;:'&lt;&gt;\\./?]{4,}$/.test(newPassword)){showMessage('message-area','新しいパスコードは4文字以上の半角英数字記号で入力してください。','error');return}if(newPassword!==confirmNewPassword){showMessage('message-area','新しいパスコードが一致しません。','error');return}const authenticatedUser=await authenticateUser(user.kaferId,currentPassword);if(!authenticatedUser){showMessage('message-area','現在のパスコードが間違っています。','error');return}const success=await writeToSheet(user.name,user.kaferId,'pass_update',{pass:newPassword});if(success){showMessage('message-area','パスコードが正常に変更されました。次回から新しいパスコードでログインしてください。','success');document.getElementById('pass-update-form').reset();logoutUser()}else{showMessage('message-area','パスコードの変更に失敗しました。','error')}});document.querySelectorAll('#my-payments-tab-nav .tab-button').forEach(button=>{button.addEventListener('click',e=>{showTabContent('my-payments-tab-nav',e.target.dataset.target)})});showTabContent('my-payments-tab-nav','recent-payments');const startScannerBtn=document.getElementById('start-scanner-btn');const stopScannerBtn=document.getElementById('stop-scanner-btn');const paymentCodeInput=document.getElementById('payment-code');startScannerBtn.addEventListener('click',async()=>{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){showMessage('message-area','お使いのブラウザはカメラ機能に対応していません。','error');return}if(window.location.protocol!=='https:'){showMessage('message-area','QRコードスキャナーはHTTPS接続でのみ動作します。サイトURLをHTTPSに変更してください。','error');return}if(html5QrCode){return}html5QrCode=new Html5Qrcode("reader");const config={fps:10,qrbox:{width:250,height:250},rememberLastUsedCamera:!0};try{await html5QrCode.start({facingMode:"environment"},config,(decodedText,decodedResult)=>{paymentCodeInput.value=decodedText;html5QrCode.stop().then(()=>{console.log("QR Code scanning stopped.");document.getElementById('start-scanner-btn').style.display='block';document.getElementById('stop-scanner-btn').style.display='none';html5QrCode=null}).catch(err=>{console.error("Error stopping QR Code scanning:",err)});showMessage('message-area',`QRコードをスキャンしました: ${decodedText}`,'success')},(errorMessage)=>{});startScannerBtn.style.display='none';stopScannerBtn.style.display='block';showMessage('message-area','カメラを許可し、QRコードを中央に映してください。','info')}catch(err){console.error("Error starting QR Code scanning:",err);showMessage('message-area',`QRコードスキャナーの起動に失敗しました。HTTPS接続か、カメラが許可されているか確認してください: ${err.message}`,'error');startScannerBtn.style.display='block';stopScannerBtn.style.display='none';html5QrCode=null}});stopScannerBtn.addEventListener('click',()=>{if(html5QrCode){html5QrCode.stop().then(()=>{console.log("QR Code scanning stopped.");document.getElementById('start-scanner-btn').style.display='block';document.getElementById('stop-scanner-btn').style.display='none';html5QrCode=null;hideMessage('message-area')}).catch(err=>{console.error("Error stopping QR Code scanning:",err);showMessage('message-area','QRコードスキャナーの停止に失敗しました。','error')})}})});async function updateDashboardAndPayments(){const user=getLoggedInUser();if(!user)return;const records=await fetchSheetData();document.getElementById('dashboard-name').textContent=user.name;document.getElementById('dashboard-kaferId').textContent=user.kaferId;const kaferMoneyBalance=calculateKAFerMoneyBalance(user.kaferId,records);document.getElementById('dashboard-kafer-money').textContent=`${kaferMoneyBalance}KAFer (${kafToYen(kaferMoneyBalance)}円)`;document.getElementById('current-money-balance-refund').textContent=`${kaferMoneyBalance}KAFer (${kafToYen(kaferMoneyBalance)}円)`;const paymentStatus=await calculateUserPaymentStatus(user.kaferId,records);document.getElementById('current-monthly-due').textContent=`${paymentStatus.monthlyDue}KAFer (${kafToYen(paymentStatus.monthlyDue)}円)`;const outstandingAmountDisplay=document.getElementById('outstanding-amount-display');const excessAmountDisplay=document.getElementById('excess-amount-display');const paymentStatusDisplay=document.getElementById('payment-status-display');if(paymentStatus.outstanding>0){outstandingAmountDisplay.textContent=`${paymentStatus.outstanding}KAFer (${kafToYen(paymentStatus.outstanding)}円)`;outstandingAmountDisplay.style.color='var(--error-color)';excessAmountDisplay.textContent='0KAFer';excessAmountDisplay.style.color='var(--text-color)';paymentStatusDisplay.textContent='未払い (延滞中)';paymentStatusDisplay.style.color='var(--error-color)'}else{outstandingAmountDisplay.textContent='0KAFer';outstandingAmountDisplay.style.color='var(--text-color)';excessAmountDisplay.textContent=`${paymentStatus.excess}KAFer (${kafToYen(paymentStatus.excess)}円)`;excessAmountDisplay.style.color='var(--success-color)';paymentStatusDisplay.textContent='支払い済み';paymentStatusDisplay.style.color='var(--success-color)'}await loadMyPaymentRecords(user.kaferId,records)}async function loadMyPaymentRecords(kaferId,allRecords){const recentListBody=document.getElementById('my-payments-recent-list');const allListBody=document.getElementById('my-payments-all-list');recentListBody.innerHTML='';allListBody.innerHTML='';const userRecords=allRecords.filter(r=>r.kaferId===kaferId&&['payment','pass_update','refund_request','refund_approved'].includes(r.type));const approvedRefundsForUser=allRecords.filter(r=>r.targetKaferId===kaferId&&r.type==='refund_approved');userRecords.push(...approvedRefundsForUser);userRecords.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));if(userRecords.length===0){const noRecordRow='<tr><td colspan="3">活動記録がありません。</td></tr>';recentListBody.innerHTML=noRecordRow;allListBody.innerHTML=noRecordRow;return}userRecords.forEach((record,index)=>{let description='';switch(record.type){case'payment':description=`KAFerマネーコード (${record.paymentCode}) を使用 (${record.amount}KAFer / ${kafToYen(record.amount)}円相当)`;break;case'pass_update':description=`パスコードが変更されました。`;break;case'refund_request':description=`返金申請を提出 (${record.requestAmountKaf}KAFer / ${kafToYen(record.requestAmountKaf)}円相当, 返還コード: ${record.refundCode}, ステータス: ${record.status==='pending'?'未承認':'承認済み'})`;break;case'refund_approved':description=`返金申請が承認されました (${record.refundAmountAfterFeeKaf}KAFer / ${kafToYen(record.refundAmountAfterFeeKaf)}円相当 が返金対象, 返還コード: ${record.refundCode})`;break;default:description=`未知の活動 (${record.type})`}const row=`<tr><td>${new Date(record.timestamp).toLocaleString('ja-JP')}</td><td>${record.type==='payment'?'支払い':record.type==='pass_update'?'パスコード変更':record.type==='refund_request'?'返金申請':record.type==='refund_approved'?'返金承認':'その他'}</td><td>${description}</td></tr>`;if(index<5){recentListBody.innerHTML+=row}allListBody.innerHTML+=row})};async function loadUserNotifications(){const user=getLoggedInUser();if(!user)return;const records=await fetchSheetData();const notificationsDiv=document.getElementById('user-notifications');notificationsDiv.innerHTML='';const userActivity=allRecords.filter(r=>r.kaferId===user.kaferId);const notifications=[];const paymentStatus=await calculateUserPaymentStatus(user.kaferId,records);if(paymentStatus.outstanding>0){notifications.push({type:'warning',message:`<i class="fas fa-exclamation-circle"></i> 今月の会費に${paymentStatus.outstanding}KAFer (${kafToYen(paymentStatus.outstanding)}円) 不足しています。KAFerマネーをチャージしてください。`,timestamp:new Date().toISOString()})}else{notifications.push({type:'success',message:`<i class="fas fa-check-circle"></i> 今月の会費は支払い済みです。残高: ${paymentStatus.excess}KAFer (${kafToYen(paymentStatus.excess)}円)`,timestamp:new Date().toISOString()})}if(paymentStatus.kaferMoneyBalance<PROJECT_CONFIG.DEFAULT_SYSTEM_CONFIG.base_monthly_fee_yen*PROJECT_CONFIG.KAF_MONEY_PER_YEN*.5){notifications.push({type:'info',message:`<i class="fas fa-money-bill-wave-alt"></i> KAFerマネー残高が少なくなっています。チャージをご検討ください。`,timestamp:new Date().toISOString()})}const latestPayment=userActivity.filter(r=>r.type==='payment').sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp))[0];if(latestPayment){notifications.push({type:'info',message:`<i class="fas fa-check"></i> ${new Date(latestPayment.timestamp).toLocaleDateString('ja-JP')}にKAFerマネーコードを使用しました。`,timestamp:latestPayment.timestamp})}const userRefundRequests=userActivity.filter(r=>r.type==='refund_request');userRefundRequests.forEach(req=>{const approvedRecord=records.find(r=>r.type==='refund_approved'&&r.refundCode===req.refundCode);if(approvedRecord){notifications.push({type:'success',message:`<i class="fas fa-undo"></i> ${new Date(approvedRecord.timestamp).toLocaleDateString('ja-JP')}の返金申請 (コード: ${req.refundCode}) が承認されました。`,timestamp:approvedRecord.timestamp})}else{notifications.push({type:'info',message:`<i class="fas fa-clock"></i> ${new Date(req.timestamp).toLocaleDateString('ja-JP')}の返金申請 (コード: ${req.refundCode}) は現在審査中です。`,timestamp:req.timestamp})}});notifications.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));if(notifications.length===0){notificationsDiv.innerHTML='<div class="log-entry"><i class="fas fa-info-circle"></i> あなたへのお知らせはまだありません。</div>';return}notifications.slice(0,5).forEach(notification=>{const entry=document.createElement('div');entry.className='log-entry';entry.innerHTML=notification.message;notificationsDiv.appendChild(entry)})};async function loadAdminAnnouncements(){const records=await fetchSheetData();const announcementsDiv=document.getElementById('admin-announcements');announcementsDiv.innerHTML='';const announcements=records.filter(r=>r.type==='announcement');announcements.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));if(announcements.length===0){announcementsDiv.innerHTML='<div class="log-entry"><i class="fas fa-info-circle"></i> 運営からのお知らせはまだありません。</div>';return}announcements.slice(0,5).forEach(announcement=>{const announcementEntry=document.createElement('div');announcementEntry.className='log-entry';announcementEntry.innerHTML=`<i class="fas fa-bullhorn"></i> [${new Date(announcement.timestamp).toLocaleDateString('ja-JP')}] ${announcement.message}`;announcementsDiv.appendChild(announcementEntry)})}</script></body></html>