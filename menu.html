<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAFer v2.0 - Menu</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="icon.png" type="image/png">
</head>
<body>
    <div class="container">
        <h1>メニュー</h1>
        <p>ようこそ、<strong id="userName"></strong> さん！</p>
        <div id="contentArea"><div class="loading-spinner"></div></div>
        <div class="menu-grid">
            <button class="button" data-content="paymentInfo">支払い情報</button>
            <button class="button" data-content="paymentStatus">全会員の支払状況</button>
            <button class="button" data-content="submitCode">コード入力</button>
            <button class="button" data-content="accountConfirm">アカウント確認</button>
            <button class="button" data-content="changePasscode">パスコード変更</button>
            <button class="button" data-content="withdrawal">退会</button>
        </div>
        <button id="logoutButton" class="link-button" style="margin-top: 30px;">ログアウト</button>
    </div>

    <div id="customModal" class="modal-overlay"></div>
    <div id="notification-container"></div>

    <script src="global.js"></script>
    <script>
        const userName = getLoggedInUserName();
        const userId = getLoggedInKAFerID();
        const contentArea = document.getElementById('contentArea');

        document.addEventListener('DOMContentLoaded', () => {
            if (!userId || getUserVersion() !== 'v2.0') { window.location.href = 'index.html'; return; }
            document.getElementById('userName').textContent = userName;
            document.getElementById('logoutButton').addEventListener('click', () => { logout(); window.location.href = 'index.html'; });
            loadContent('paymentInfo');
            document.querySelectorAll('.menu-grid .button').forEach(btn => btn.addEventListener('click', () => loadContent(btn.dataset.content)));
        });

        async function loadContent(contentType) {
            contentArea.innerHTML = `<div class="loading-spinner"></div>`;
            try {
                const allData = await fetchKAFerData();
                const registerInfo = allData.find(r => r.F === userId && r.e === 'register');
                if (!registerInfo || !registerInfo.K) { contentArea.innerHTML = `<p class="message error">あなたの登録情報が見つかりません。</p>`; return; }
                const myRegisterDate = new Date(registerInfo.K);
                const myPayments = allData.filter(row => row.F === userId && row.e === 'payment').map(p => ({...p, date: new Date(p.K)}));

                let unpaidAmount = 0, consecutiveDelinquent = 0;
                let checkDate = new Date(myRegisterDate.getFullYear(), myRegisterDate.getMonth(), 1);
                const today = new Date(); today.setDate(1);

                while (checkDate < today) {
                    const monthStr = getMonthYear(checkDate);
                    if (!myPayments.some(p => getMonthYear(p.date) === monthStr)) {
                        unpaidAmount += calculateBilling(getActiveUsers(allData, checkDate).length);
                        consecutiveDelinquent++;
                    } else {
                        consecutiveDelinquent = 0;
                    }
                    checkDate.setMonth(checkDate.getMonth() + 1);
                }

                let content = '';
                switch(contentType) {
                    case 'paymentInfo':
                        const activeNow = getActiveUsers(allData).length;
                        const currentBilling = calculateBilling(activeNow);
                        const totalBilling = currentBilling + unpaidAmount;
                        content = `<h2>支払い情報</h2><div class="content-box">
                            <div class="info-item"><span class="info-label">今月の請求額</span><span class="info-value">¥${currentBilling.toLocaleString()}</span></div>
                            <div class="info-item"><span class="info-label">未払い合計額</span><span class="info-value">¥${unpaidAmount.toLocaleString()}</span></div>
                            <div class="info-item" style="background: #fcefee;"><span class="info-label"><strong>合計請求額</strong></span><span class="info-value"><strong>¥${totalBilling.toLocaleString()}</strong></span></div>
                            <div class="info-item"><span class="info-label">集金期間</span><span class="info-value">毎月1日～末日</span></div>
                        </div>`;
                        break;
                    case 'paymentStatus':
                        const users = allData.filter(r => r.e === 'register' && !allData.some(rem => rem.F === r.F && rem.e === 'remove'));
                        const payments = allData.filter(r => r.e === 'payment');
                        const currentMonth = getMonthYear(new Date());
                        let tableRows = users.map(user => {
                            const isPaid = payments.some(p => p.F === user.F && getMonthYear(new Date(p.K)) === currentMonth);
                            return `<tr><td>${user.A}</td><td class="${isPaid ? 'paid' : 'unpaid'}">${isPaid ? '支払い済み' : '未払い'}</td></tr>`;
                        }).join('');
                        content = `<h2>全会員の支払状況 (${currentMonth})</h2><table class="data-table"><thead><tr><th>名前</th><th>状況</th></tr></thead><tbody>${tableRows}</tbody></table>`;
                        break;
                    case 'submitCode':
                        content = `<h2>支払いコード入力</h2><div class="content-box">
                            <input type="number" id="paymentCodeInput" placeholder="6桁の支払いコード">
                            <button id="submitPaymentCode">支払いを確定する</button>
                            <div id="paymentMsg" class="message hidden"></div>
                        </div>`;
                        break;
                    case 'accountConfirm':
                        const config = allData.filter(r => r.e === 'config' && r.r).pop();
                        const accInfo = config ? JSON.parse(config.r) : { email: '未設定', pass: '未設定' };
                        const isLocked = consecutiveDelinquent >= 3;
                        if(isLocked) showModal('アカウントロック', '3ヶ月以上の料金延滞があるため、アカウント情報を確認できません。');
                        content = `<h2>アカウント確認</h2><div class="content-box ${isLocked ? 'locked-account' : ''}">
                            <div class="info-item"><span class="info-label">メール</span><span class="info-value">${accInfo.email}</span></div>
                            <div class="info-item"><span class="info-label">パスワード</span><span class="info-value">${accInfo.pass}</span></div>
                        </div>`;
                        break;
                    case 'changePasscode':
                        content = `<h2>パスコード変更</h2><div class="content-box">
                            <p>セキュリティのため、定期的なパスコードの変更を推奨します。</p>
                            <input type="password" id="currentPasscode" maxlength="4" placeholder="現在のパスコード (4桁)">
                            <input type="password" id="newPasscode" maxlength="4" placeholder="新しいパスコード (4桁)">
                            <input type="password" id="confirmNewPasscode" maxlength="4" placeholder="新しいパスコード (確認)">
                            <button id="submitChangePasscode">変更を保存</button>
                        </div>`;
                        break;
                    case 'withdrawal':
                        let totalOverpayment = 0;
                        for (const payment of myPayments) {
                            const activeCount = getActiveUsers(allData, payment.date).length;
                            const billing = calculateBilling(activeCount);
                            const totalCollected = billing * activeCount;
                            if (totalCollected > 990) totalOverpayment += Math.floor((totalCollected - 990) / activeCount);
                        }
                        content = `<h2>退会手続き</h2><div class="content-box">
                            <p class="message warning">本当に退会しますか？この操作は取り消せません。</p>
                            <div class="info-item"><span class="info-label">過払い金合計 (返金額目安)</span><span class="info-value">¥${totalOverpayment.toLocaleString()}</span></div>
                            <button id="confirmWithdrawal" class="button">退会を確定する</button>
                        </div>`;
                        break;
                }
                contentArea.innerHTML = content;
                attachEventListeners(contentType, allData);
            } catch(e) {
                contentArea.innerHTML = `<p class="message error">データの表示中にエラーが発生しました。</p>`;
                console.error(e);
            }
        }

        function attachEventListeners(contentType, allData) {
            if (contentType === 'submitCode') {
                const button = document.getElementById('submitPaymentCode');
                button.addEventListener('click', async () => { /* ... (変更なし) ... */ });
            } else if (contentType === 'withdrawal') {
                document.getElementById('confirmWithdrawal').addEventListener('click', () => {
                    showModal('最終確認', '本当に退会しますか？この操作は取り消せません。', [
                        { text: '実行する', class: 'button danger', action: executeWithdrawal },
                        { text: 'キャンセル', class: 'link-button', action: hideModal }
                    ]);
                });
            } else if (contentType === 'changePasscode') {
                document.getElementById('submitChangePasscode').addEventListener('click', () => handleChangePasscode(allData));
            }
        }
        
        async function executeWithdrawal() { /* ... (変更なし) ... */ }

        async function handleChangePasscode(allData) {
            const currentPassEl = document.getElementById('currentPasscode');
            const newPassEl = document.getElementById('newPasscode');
            const confirmPassEl = document.getElementById('confirmNewPasscode');

            const currentPass = currentPassEl.value;
            const newPass = newPassEl.value;
            const confirmPass = confirmPassEl.value;

            if (!/^\d{4}$/.test(currentPass) || !/^\d{4}$/.test(newPass)) {
                showModal('入力エラー', 'パスコードは4桁の数字で入力してください。'); return;
            }
            if (newPass !== confirmPass) {
                showModal('入力エラー', '新しいパスコードが一致しません。'); return;
            }

            const passcodeRecords = allData.filter(row => row.F === userId && (row.e === 'register' || row.e === 'pass_update'));
            const latestPasscodeRecord = passcodeRecords.pop();
            const storedPasscode = JSON.parse(latestPasscodeRecord.r).pass;
            
            if (currentPass !== storedPasscode) {
                showModal('認証エラー', '現在のパスコードが違います。'); return;
            }
            
            hideModal();
            showNotification('パスコードを変更中...', 'warning');

            const formData = new FormData();
            formData.append(ENTRY_MAP.id, userId);
            formData.append(ENTRY_MAP.name, userName);
            formData.append(ENTRY_MAP.type, 'pass_update');
            formData.append(ENTRY_MAP.data, JSON.stringify({ pass: newPass }));
            await postToGoogleForm(formData);
            
            try {
                await pollForData(data => data.some(r => r.F === userId && r.e === 'pass_update' && r.r.includes(newPass)));
                showNotification('パスコードが正常に変更されました。', 'success');
                currentPassEl.value = ''; newPassEl.value = ''; confirmPassEl.value = '';
            } catch (e) {
                showModal('エラー', e.message);
            }
        }
    </script>
</body>
</html>
