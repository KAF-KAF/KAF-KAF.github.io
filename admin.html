<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAFer - Admin Panel</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="icon.png" type="image/png">
</head>
<body>
    <div class="container admin-container">
        <h1>管理者パネル</h1>
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="dashboard">ダッシュボード</button>
            <button class="tab-button" data-tab="codes">コード管理</button>
            <button class="tab-button" data-tab="config">設定変更</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <h2>会員と支払い状況</h2>
            <div class="filter-controls" style="text-align: right; margin-bottom: 10px;">
                <label style="cursor: pointer;"><input type="checkbox" id="showRemovedToggle" onchange="loadDashboard()"> 退会済み会員を表示</label>
            </div>
            <div id="dashboardContent"><div class="loading-spinner"></div></div>
        </div>
        
        <div id="codes" class="tab-content">
            <!-- ... コード管理タブ (変更なし) ... -->
        </div>
        
        <div id="config" class="tab-content">
            <!-- ... 設定変更タブ (変更なし) ... -->
        </div>

        <button id="adminLogout" class="link-button" style="margin-top: 30px;">ログアウト</button>
    </div>
    
    <div id="customModal" class="modal-overlay"></div>
    <div id="notification-container"></div>
    
    <script src="global.js"></script>
    <script>
        // --- 初期化とタブ切り替え (変更なし) ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!isAdmin()) { window.location.href = 'index.html'; return; }
            document.getElementById('adminLogout').addEventListener('click', () => { logout(); window.location.href = 'index.html'; });
            document.querySelectorAll('.tab-button').forEach(btn => { /* ... */ });
            loadDashboard(); loadCodes();
            document.getElementById('updateConfigButton').addEventListener('click', handleUpdateConfig);
        });

        // ★★★ ダッシュボード読み込み処理を更新 ★★★
        async function loadDashboard() {
            const content = document.getElementById('dashboardContent');
            content.innerHTML = `<div class="loading-spinner"></div>`;
            const allData = await fetchKAFerData();
            const users = allData.filter(r => r.e === 'register');
            const removals = allData.filter(r => r.e === 'remove').map(r => r.F);
            const versions = allData.filter(r => r.e === 'version_select');
            const showRemoved = document.getElementById('showRemovedToggle').checked;

            let rows = users.map(user => {
                const isRemoved = removals.includes(user.F);
                if (isRemoved && !showRemoved) return ''; // 非表示トグルがオフなら表示しない

                const userVersionInfo = versions.filter(v => v.F === user.F).pop();
                const version = (userVersionInfo && JSON.parse(userVersionInfo.r).version) ? JSON.parse(userVersionInfo.r).version : 'v1.0';
                
                let actionButton = '-';
                if (!isRemoved && version === 'v1.0') {
                    actionButton = `<button class="button" onclick="promptForceUpdate('${user.F}', '${user.A}')">v2.0へ更新</button>`;
                }

                return `<tr style="${isRemoved ? 'opacity:0.4; text-decoration: line-through;' : ''}">
                    <td>${user.A}</td>
                    <td>${user.F}</td>
                    <td>${isRemoved ? '退会済み' : version}</td>
                    <td>${actionButton}</td>
                </tr>`;
            }).join('');

            content.innerHTML = `<table class="data-table">
                <thead><tr><th>名前</th><th>KAFerID</th><th>バージョン</th><th>操作</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>`;
        }
        
        // ★★★ 強制アップデートのモーダル表示機能 ★★★
        function promptForceUpdate(id, name) {
            const modalContent = document.createElement('div');
            modalContent.innerHTML = `
                <p>ユーザー「${name}」をv2.0にアップデートします。</p>
                <p>v2.0のログインにはパスコードが必要です。ユーザーのための<strong>仮パスコード（4桁の数字）</strong>を設定してください。</p>
                <input type="password" id="tempPasscode" maxlength="4" placeholder="仮パスコード (4桁)" style="padding: 10px; font-size: 1.2em; text-align: center; width: 150px; margin-top: 10px;">
                <p style="font-size: 0.8em; color: #555;">※アップデート後、ユーザー本人にこの仮パスコードを伝え、すぐに変更するよう促してください。</p>
            `;
            showModal('強制アップデート確認', modalContent, [
                { text: '実行する', class: 'button', action: () => executeForceUpdate(id, name) },
                { text: 'キャンセル', class: 'link-button', action: hideModal }
            ]);
        }

        // ★★★ 強制アップデートの実行機能 ★★★
        async function executeForceUpdate(id, name) {
            const tempPasscode = document.getElementById('tempPasscode').value;
            if (!/^\d{4}$/.test(tempPasscode)) {
                alert('仮パスコードは4桁の数字で入力してください。');
                return;
            }
            hideModal();
            showNotification(`「${name}」のアップデート処理を開始...`, 'warning');

            try {
                // 1. パスコードを記録
                const passFormData = new FormData();
                passFormData.append(ENTRY_MAP.id, id);
                passFormData.append(ENTRY_MAP.name, name);
                passFormData.append(ENTRY_MAP.type, 'pass_update');
                passFormData.append(ENTRY_MAP.data, JSON.stringify({ pass: tempPasscode }));
                await postToGoogleForm(passFormData);
                await pollForData(data => data.some(r => r.F === id && r.e === 'pass_update' && r.r.includes(tempPasscode)));
                
                // 2. バージョン情報を記録
                const versionFormData = new FormData();
                versionFormData.append(ENTRY_MAP.id, id);
                versionFormData.append(ENTRY_MAP.name, name);
                versionFormData.append(ENTRY_MAP.type, 'version_select');
                versionFormData.append(ENTRY_MAP.data, JSON.stringify({ version: 'v2.0' }));
                await postToGoogleForm(versionFormData);
                await pollForData(data => data.some(r => r.F === id && r.e === 'version_select' && r.r.includes('v2.0')));
                
                showNotification(`「${name}」をv2.0にアップデートしました！`, 'success');
                
            } catch (e) {
                showModal('エラー', e.message);
            } finally {
                loadDashboard(); // ダッシュボードを再読み込みして表示を更新
            }
        }
        
        // --- コード管理と設定変更の関数 (前回から変更なし) ---
        async function loadCodes() { /* ... */ }
        async function issueCode() { /* ... */ }
        async function voidCode(code, button) { /* ... */ }
        async function handleUpdateConfig() { /* ... */ }

        // 上記関数のためのイベントリスナー設定
        document.addEventListener('DOMContentLoaded', () => {
             // ...
             document.getElementById('updateConfigButton').addEventListener('click', handleUpdateConfig);
        });

    </script>
</body>
</html>
